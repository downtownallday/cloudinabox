load '../funcs.rb'

Vagrant.configure("2") do |config|

  config.vm.synced_folder "../../..", "/cloudinabox", id: "cloudinabox", automount: false
  config.vm.network "public_network", bridge: "#$default_network_interface"
  #use_preloaded_box config, "ubuntu/focal64", ".."
  use_preloaded_box config, "ubuntu/jammy64", ".."

  if ENV['tests']=='miab'

    # vanilla connected to miab (miab-ldap with hostname "vanilla.local"
    # must be up and running)

    config.vm.define "vanilla" do |m1|
      m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
export PRIMARY_HOSTNAME=vanilla-ciab.local
tests/system-setup/vanilla.sh -v --qa-ca; rc=$?  # --enable-mod=coturn
echo "EXITCODE: $rc"
if [ $rc -eq 0 ]; then
   setup/connect-nextcloud-to-miab.sh /usr/local/nextcloud admin $(. /etc/cloudinabox.conf; . $STORAGE_ROOT/nextcloud/ciab_nextcloud.conf; echo "$NC_ADMIN_PASSWORD") vanilla.local Test_LDAP_1234
   rc=$?
fi
exit $rc
SH
    end

  else

    # vanilla (default)
    
    config.vm.define "vanilla" do |m1|
      m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
export PRIMARY_HOSTNAME=vanilla-ciab.local
#export REQUIRED_NC_FOR_FRESH_INSTALLS=24.0.0rc3
tests/system-setup/vanilla.sh -v; rc=$?  # --enable-mod=coturn
echo "EXITCODE: $rc"
SH
    end

  end


end
