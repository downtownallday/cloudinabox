load './funcs.rb'

Vagrant.configure("2") do |config|

  config.vm.synced_folder "../..", "/cloudinabox", id: "cloudinabox", automount: false
  config.vm.network "public_network", bridge: "#$default_network_interface"

  #
  # vanilla with ubuntu 20 (focal), then upgrade to ubuntu 22 (jammy)
  # requires plugin 'vagrant-reload'
  #

  if ENV['tests']=='all'
    config.vm.define "vanilla-focal2jammy" do |m1|
      if !Vagrant.has_plugin?('vagrant-reload')
        raise("Plugin 'vagrant-reload' is required")
      end
    
      use_preloaded_box m1, "ubuntu/focal64"
      m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
export PRIMARY_HOSTNAME=f2j1.abc.com
export SKIP_SYSTEM_UPDATE=0
tests/system-setup/vanilla.sh -v || exit 1
tests/runner.sh default || exit 2
SH

      # reboot may be required when updates were applied
      m1.vm.boot_timeout = 600
      m1.vm.provision :reload

      # upgrade ubuntu
      m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
tests/bin/wait_for_network.sh
tests/bin/do_release_upgrade.sh || exit 3
# allow insecure ssh-rsa to avoid Vagrant autentication failure on reload
echo PubkeyAcceptedAlgorithms +ssh-rsa > /etc/ssh/sshd_config.d/ciab.conf
SH

      # reboot required after any system upgrade
      m1.vm.provision :reload

      m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
source tests/system-setup/setup-defaults.sh
setup/start.sh -v || exit 4
tests/runner.sh default || exit 5
SH
    end
  end
  
  
  #
  # jammy
  # vanilla with encryption-at-rest
  #
  
  config.vm.define "vanilla-ehdd" do |m1|
    use_preloaded_box m1, "ubuntu/jammy64"    
    m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
export PRIMARY_HOSTNAME=qa2.abc.com
export EHDD_KEYFILE=$HOME/keyfile
echo -n "boo" >$EHDD_KEYFILE
tests/system-setup/vanilla.sh || exit 1
tests/runner.sh default || exit 2
SH
  end

  #
  # from-backup: restore a backup, then install
  #

  config.vm.define "from-backup" do |m1|
    use_preloaded_box m1, "ubuntu/jammy64"
    m1.vm.provision :shell, :inline => <<-SH
cd /cloudinabox
export PRIMARY_HOSTNAME=qacloud.int.com
tests/system-setup/from-backup.sh backup2 || exit 1
tests/runner.sh default upgrade-backup2 || exit 2
SH
  end

end
